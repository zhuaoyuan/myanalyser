# myanalyser 系统设计

## 1. 目标与范围

本项目面向自用基金分析场景，覆盖数据采集、清洗校验、回测与榜单生成。  
本文件描述目录分层、核心模块职责、数据流和统一验收机制，用于保证工程化可维护。

## 2. 目录分层

```text
myanalyser/
  src/        # 业务代码与 CLI
  tests/      # 单元测试与集成测试
  data/       # 原始/中间/样例数据
  artifacts/  # 运行产物
  docs/       # 文档
  tools/      # 一次性脚本
```

设计原则：

- 业务代码与测试分离（`src/` 与 `tests/`）
- 数据与代码分离（`data/` 与 `src/`）
- 文档与实现同步维护（`docs/`）

## 3. 数据目录与版本化

统一约定：

- 公共数据：`data/common/`（如 `trade_dates.csv`）
- 样例数据：`data/samples/`
- 跑数版本数据：`data/versions/{run_id}/`
- 每个版本的 ETL 结果：`data/versions/{run_id}/fund_etl/`
- 每个版本的错误日志：`data/versions/{run_id}/logs/`

`run_id` 规则：

- 默认：`YYYYMMDD_HHMMSS`
- 可拼接描述后缀：`YYYYMMDD_HHMMSS_desc`

该结构确保每次测试/正式跑数数据彼此隔离、可回溯、可复现。

## 4. 核心模块职责

- `src/fund_etl.py`：AkShare 数据采集（step1~step7、retry）
- `src/adjusted_nav_tool.py`：复权净值计算
- `src/compare_adjusted_nav_and_cum_return.py`：复权收益率与累计收益率一致性比对
- `src/check_trade_day_data_integrity.py`：交易日数据完整性检查
- `src/pipeline_scoreboard.py`：评分榜单计算与导出（支持 `--skip-sinks`）
- `src/backtest_portfolio.py`：回测流程执行

关键输入输出边界：

- 输入优先从 `data/versions/{run_id}/fund_etl/` 读取
- 日志优先写入 `data/versions/{run_id}/logs/`
- 可视化/报告类产物优先写入 `artifacts/`

## 5. 统一验收机制

统一脚本：`tools/verify.sh`

执行顺序：

1. 单测回归（`python -m unittest discover`）
2. 核心 CLI smoke（5 个核心 CLI 的集成测试）
3. 在新目录结构下创建测试 run_id 数据
4. 真实执行数据完整性检查 CLI

验收通过标准：

- 单测全绿
- 核心 CLI smoke 全绿
- 产出完整性检查汇总文件

## 6. 兼容性与演进策略

- 不保留根目录兼容入口，统一 `python src/xxx.py`
- 通过文档和统一验收脚本约束路径改动，降低后续回归风险
- 若引入 `make verify`，建议仅转调 `bash tools/verify.sh`，避免逻辑分叉
