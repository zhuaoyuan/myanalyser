# myanalyser 系统设计

## 1. 目标与范围

本项目面向自用基金分析场景，覆盖数据采集、清洗校验、回测与榜单生成。  
本文件描述目录分层、核心模块职责、数据流和统一验收机制，用于保证工程化可维护。

## 2. 目录分层

```text
myanalyser/
  src/        # 业务代码与 CLI
  tests/      # 单元测试与集成测试
  data/       # 原始/中间/样例数据
  artifacts/  # 运行产物
  docs/       # 文档
  tools/      # 一次性脚本
```

设计原则：

- 业务代码与测试分离（`src/` 与 `tests/`）
- 数据与代码分离（`data/` 与 `src/`）
- 文档与实现同步维护（`docs/`）

## 3. 数据目录与版本化

统一约定：

- 公共数据：`data/common/`（如 `trade_dates.csv`）
- 样例数据：`data/samples/`
- 跑数版本数据：`data/versions/{run_id}/`
- 每个版本的 ETL 结果：`data/versions/{run_id}/fund_etl/`
- 每个版本的错误日志：`data/versions/{run_id}/logs/`

`run_id` 规则：

- 默认：`YYYYMMDD_HHMMSS`
- 可拼接描述后缀：`YYYYMMDD_HHMMSS_desc`

该结构确保每次测试/正式跑数数据彼此隔离、可回溯、可复现。

## 4. 核心模块职责

- `src/fund_etl.py`：AkShare 数据采集（step1~step7、retry）
- `src/adjusted_nav_tool.py`：复权净值计算
- `src/compare_adjusted_nav_and_cum_return.py`：复权收益率与累计收益率一致性比对
- `src/check_trade_day_data_integrity.py`：交易日数据完整性检查
- `src/pipeline_scoreboard.py`：评分榜单计算与导出（支持 `--skip-sinks`）
- `src/backtest_portfolio.py`：回测流程执行

关键输入输出边界：

- 输入优先从 `data/versions/{run_id}/fund_etl/` 读取
- 日志优先写入 `data/versions/{run_id}/logs/`
- 可视化/报告类产物优先写入 `artifacts/`

## 5. 统一验收机制（E2E）

统一脚本：`tools/verify.sh`

执行顺序（10 步）：

1. 单测回归（`python -m unittest discover`）
2. 核心 CLI smoke（5 个核心 CLI 的集成测试）
3. 启动 `fund_db_infra` 并检查 MySQL/ClickHouse 健康状态
4. 执行 `fund_etl verify + step1`
5. 将 `fund_purchase.csv` 抽样为 101 只（前 100 + `163402`）
6. 执行 `fund_etl step2~step7`
7. 执行复权净值计算（`adjusted_nav_tool.py`）
8. 执行交易日完整性检查（`check_trade_day_data_integrity.py`）
9. 执行复权收益率一致性比对（`compare_adjusted_nav_and_cum_return.py`）
10. 执行榜单入库与导出 + 2025 年回测（`pipeline_scoreboard.py` + `backtest_portfolio.py`）

验收通过标准：

- 单测全绿
- 核心 CLI smoke 全绿
- ETL/校验/回测链路均有产物且关键 CSV 非空
- DB Sink 写入无阻断（MySQL + ClickHouse）

## 6. 数据库与写入稳定性设计

- MySQL `data_version` 字段采用 `VARCHAR(64)`，避免版本号长度被 `CHAR(6)` 限制。
- ClickHouse 写入采取“分区感知 + 小批次聚合写入”：
  - 按分区键预分组，避免单次 INSERT 覆盖超过 `max_partitions_per_insert_block`。
  - 将分组按批打包，降低碎片化写入与 `TOO_MANY_PARTS` 风险。
  - 对大表设置 `chunk_rows`，控制单批 CSV 体积，降低内存尖峰。
- 问题排查优先看：
  - `system.merges`（后台合并压力）
  - `system.error_log`（`MEMORY_LIMIT_EXCEEDED`/`TOO_MANY_PARTS`）

## 7. 兼容性与演进策略

- 不保留根目录兼容入口，统一 `python src/xxx.py`
- 通过文档和统一验收脚本约束路径改动，降低后续回归风险
- 若引入 `make verify`，建议仅转调 `bash tools/verify.sh`，避免逻辑分叉
