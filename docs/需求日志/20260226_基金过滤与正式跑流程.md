# 20260226 基金过滤与正式跑流程

## 1. 需求背景

本次需求围绕端到端流程增强，核心目标是：

1. 在 Step 9（复权收益率比对）后增加一层基金过滤，防止质量不满足条件的基金进入后续链路。
2. 将过滤结果接入 `tools/verify.sh`，放在 Step 9 与 Step 10 之间，并让 Step 10 消费过滤后的基金清单。
3. 新增“正式跑数”脚本，区别于验收跑脚本。
4. 将正式跑中的 backtest 剥离，后续独立执行。
5. 将以上变化同步到项目元文件（README、系统设计、需求日志）。

## 2. 需求与实现映射

### 2.1 新增基金过滤脚本

新增 `src/filter_funds_for_next_step.py`，输出字段：

- `基金编码`
- `是否过滤`
- `过滤原因`（未过滤为空；多条原因用 `；` 拼接）

过滤规则：

1. `fund_overview.csv` 不存在该基金 -> 过滤  
2. `fund_nav_by_code` 不存在该基金 -> 过滤  
3. `fund_adjusted_nav_by_code` 不存在该基金 -> 过滤  
4. `fund_return_compare/details/{code}.csv` 在指定日期后：
   - 无任何比对记录，或
   - 存在 `abs(本地远程收益率偏差) >= 阈值`
   -> 过滤  
5. `trade_day_integrity_reports/details_{start}_{end}/{code}_*.csv` 在指定日期后存在不完整交易日 -> 过滤

默认参数：

- `start_date=2023-01-01`
- `max_abs_deviation=0.02`

### 2.2 接入 verify 验收流程

`tools/verify.sh` 增加 Step 9.5：

- 执行 `filter_funds_for_next_step.py`
- 生成 `artifacts/verify_${RUN_ID}/filtered_fund_candidates.csv`
- 基于过滤结果生成 `fund_purchase_for_step10_filtered.csv`
- Step 10 改为消费 `fund_purchase_for_step10_filtered.csv`

### 2.3 新增正式跑脚本

新增 `tools/run_full_pipeline.sh`：

- 面向正式跑数，执行全量 ETL（`fund_etl --mode all`）
- 包含完整性检查、收益率比对、Step 9.5 过滤、评分落库
- 使用过滤后的 purchase 清单进入评分流程

### 2.4 正式跑剔除 backtest

根据后续需求，`run_full_pipeline.sh` 删除 backtest 阶段：

- 删除 backtest 变量与步骤
- 总步骤改为 7 步
- 输出中不再包含 backtest 产物路径

## 3. 本次改动文件

- `src/filter_funds_for_next_step.py`（新增）
- `tests/test_filter_funds_for_next_step.py`（新增）
- `tools/verify.sh`（新增 Step 9.5，并接入过滤后 purchase）
- `tools/run_full_pipeline.sh`（新增正式跑脚本，后续移除 backtest）
- `docs/README.md`（新增“验收跑 vs 正式跑”说明，并同步“正式跑不含 backtest”）
- `docs/系统设计.md`（同步两类流程、9.5 过滤与正式跑终点）
- `docs/需求日志/20260226_基金过滤与正式跑流程.md`（本文件）

## 4. 验收与检查记录

已执行：

- `python -m unittest -v myanalyser/tests/test_filter_funds_for_next_step.py`
- `bash -n myanalyser/tools/verify.sh`
- `bash -n myanalyser/tools/run_full_pipeline.sh`
- 对新增/修改文件执行 lint 检查（无新增问题）

样例实跑（验证脚本可用）：

- 基于 `verify_20260226_full_e2e_verify_v3` 产物生成过滤结果
- 输出：`filtered_fund_candidates.csv`
- 样例统计：总基金 `101`，过滤 `27`

## 5. 当前流程边界（更新后）

- 验收跑：`tools/verify.sh`  
  含测试、抽样、Step 9.5 过滤、评分落库与回测。

- 正式跑：`tools/run_full_pipeline.sh`  
  不含测试与抽样，执行全量 ETL + 过滤 + 评分落库，不含回测。

- 回测：后续独立执行（不耦合在正式跑脚本内）。
