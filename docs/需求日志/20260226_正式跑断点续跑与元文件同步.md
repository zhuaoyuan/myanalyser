# 20260226 正式跑断点续跑与元文件同步

## 1. 需求背景

开发者提出 `tools/run_full_pipeline.sh` 在中途失败后应支持复用已完成产物：

- 同一个 `run_id` 再次执行时，不应无差别重算
- 每一步应先判断结果是否完整，完整则跳过进入下一步
- 目标是把单脚本已有的“可跳过/可重入”能力扩展到整条正式跑流程

在脚本改造完成并确认后，本次继续要求：按 `docs/项目通用约束.md` 同步更新元文件。

## 2. 实现方案与落地

### 2.1 `run_full_pipeline.sh` 增加步骤级 checkpoint

在 `artifacts/full_run_${RUN_ID}/.checkpoints` 下新增步骤完成标记：

- `step2_fund_etl.ok`
- `step3_adjusted_nav.ok`
- `step4_integrity.ok`
- `step5_compare.ok`
- `step6_filter.ok`
- `step6b_filtered_purchase.ok`
- `step7_scoreboard.ok`

并新增函数：

- `checkpoint_path`
- `mark_checkpoint`
- `has_checkpoint`

执行逻辑改为：

1. 若命中 checkpoint，先校验关键产物完整性（CSV 非空、目录有 CSV），通过则跳过该步骤。
2. 若未命中 checkpoint，执行原步骤；成功后再次校验并写入 checkpoint。

备注：`step1`（拉起 DB 基础设施）保持每次执行，确保容器状态可用。

### 2.2 防止误跳过

为避免“checkpoint 存在但产物缺失”造成脏跳过，命中 checkpoint 时仍执行产物校验，不通过则立即失败。

## 3. 元文件同步范围

本次按约束同步以下元文件：

- `docs/README.md`
  - 正式跑能力补充“同 `RUN_ID` 断点续跑”
  - 产物目录补充 `.checkpoints`
- `docs/系统设计.md`
  - 正式跑机制补充 checkpoint 设计说明
  - 正式跑关键产物补充 `.checkpoints`
- `docs/需求日志/20260226_正式跑断点续跑与元文件同步.md`（本文件）

## 4. 会话记录（开发者提示与 AI 回复）

### Round 1

- 开发者：提出正式跑中断后复用中间产物诉求，询问整体是否可做。
- AI：确认可做，完成 `run_full_pipeline.sh` 改造，加入 checkpoint 与步骤完整性检查，并说明重跑行为。

### Round 2

- 开发者：要求基于 `docs/项目通用约束.md` 更新本次需求到元数据。
- AI：更新 `README`、`系统设计` 与需求日志，记录本次改造目标、实现细节和产物变化。

## 5. 验证记录

本次元文件同步阶段执行：

- 对变更脚本与文档进行静态检查（lints 无新增问题）
- 复查 `tools/run_full_pipeline.sh` 断点逻辑与关键路径引用一致

## 6. 当前结论

- 正式跑流程已具备同 `run_id` 的步骤级断点续跑能力。
- 元文件已同步该能力的使用语义与产物位置，便于后续协作和运维。
