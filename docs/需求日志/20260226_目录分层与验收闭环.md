# 需求日志：目录分层与验收闭环

## 1. 背景

本次需求聚焦 `myanalyser` 的工程化与可维护性，目标是完成目录分层整理并同步更新路径/配置，确保运行兼容。

目标目录：

- `src/`（业务代码）
- `tests/`（测试）
- `data/`（原始/中间/样例）
- `artifacts/`（运行产物）
- `docs/`（说明、约束、日志、设计）
- `tools/`（一次性脚本）

## 2. 关键决策

### 2.1 run_id 与数据版本目录

- 默认 `run_id`：`YYYYMMDD_HHMMSS`
- 允许拼接描述后缀
- ETL 结果目录：`data/versions/{run_id}/fund_etl`
- 错误日志目录：`data/versions/{run_id}/logs`（与结果目录分离）

### 2.2 入口策略

- 不保留根目录兼容入口
- 统一命令方式：`python src/xxx.py`

### 2.3 验收入口

- 先实现 `tools/verify.sh`
- 后续如需 `make verify`，仅作为转调入口

## 3. 实现摘要

- 完成目录迁移：`src/tests/docs/tools/data/artifacts`
- 新增 `src/project_paths.py` 统一项目根路径与 run_id 生成
- 更新核心 CLI 路径逻辑，适配新目录结构
- 调整日志输出路径到 `data/versions/{run_id}/logs`
- 新增 `tests/test_cli_integration.py`，覆盖核心 CLI smoke
- 新增 `tools/verify.sh`，统一执行：
  - 单测回归
  - 5 个核心 CLI smoke
  - 数据完整性检查

## 4. 风险与处理

- 风险：路径迁移导致脚本默认路径失效  
  处理：统一改为基于项目根目录解析
- 风险：外部依赖导致沙箱导入失败  
  处理：`fund_etl` 增加受限环境下的可测试退化导入
- 风险：日志与结果混放  
  处理：错误日志迁移到 `logs/` 二级目录

## 5. 验收证据

执行命令：

```bash
cd /Users/zhuaoyuan/cursor-workspace/finance/myanalyser
source /Users/zhuaoyuan/cursor-workspace/finance/myanalyser/.venv312/bin/activate
bash tools/verify.sh
```

关键结果：

- 单测通过：`Ran 32 tests ... OK`
- 核心 CLI smoke 通过：`Ran 5 tests ... OK`
- 数据完整性检查输出成功：
  - `artifacts/verify_<run_id>/trade_day_integrity_reports/trade_day_integrity_summary_*.csv`

## 6. 后续建议

- 增加 `Makefile`，提供 `make verify` 并转调 `tools/verify.sh`
- 将 `verify.sh` 接入 CI，作为合并前必跑检查
