# 需求日志：中间产物契约校验与最小回归基线及运行报告

## 1. 需求概述

本次需求围绕两条主流程 `tools/verify.sh` 与 `tools/run_full_pipeline.sh`，目标如下：

1. 为关键中间产物补 schema 校验（列名/类型/非空/唯一键等），并在每步入口强制检查。
2. 建立最小回归基线数据集（固定样本 + 固定期望输出）并接入现有测试流程，保证重构不改结果。
3. 增加运行报告汇总（每步耗时、成功率、异常分布、过滤前后数量变化），让验收结论一眼可读。

## 2. 关键设计决策

- 校验落在具体 Python 脚本入口，而非分别在 `verify.sh` / `run_full_pipeline.sh` 重复实现，避免逻辑分叉，并兼容脚本单独执行。
- `*_by_code` 目录按目录级校验（CSV 文件数量），不逐文件读取内容，控制校验开销。
- 最小回归基线使用历史真实产物抽样，不使用 mock。
- 基线期望目录支持参数化（`MYANALYSER_BASELINE_EXPECTED_DIR`）。

## 3. 实现内容

### 3.1 契约与校验基础设施

- 新增：`src/contracts/pipeline_contracts.py`
  - 定义关键产物契约（CSV 列/非空/唯一/类型，目录 CSV 数量）。
  - 定义 stage 到产物映射（`STAGE_REQUIREMENTS`）。
- 新增：`src/validators/validate_pipeline_artifacts.py`
  - 提供 `validate_stage` / `validate_stage_or_raise`。
  - 提供 CLI：`--stage` + 多个 `--artifact key=path`，失败返回非 0。

### 3.2 入口强制校验接入（Python 环节）

已接入脚本：

- `src/fund_etl.py`
- `src/adjusted_nav_tool.py`
- `src/check_trade_day_data_integrity.py`
- `src/compare_adjusted_nav_and_cum_return.py`
- `src/filter_funds_for_next_step.py`
- `src/pipeline_scoreboard.py`
- `src/verify_scoreboard_recalc.py`

### 3.3 重复逻辑收敛

- 新增：`src/transforms/build_filtered_purchase_csv.py`
  - 将“从过滤结果生成 `fund_purchase_for_step10_filtered.csv`”抽成可复用脚本。
  - `verify.sh` 与 `run_full_pipeline.sh` 共用，不再各自内嵌重复 Python 片段。

### 3.4 最小回归基线

- 新增基线目录：`tests/baseline/mini_case/`
  - `input/`：从历史 run 抽样得到的真实输入
  - `expected/default/`：固定期望输出
- 新增测试：
  - `tests/test_pipeline_artifact_validation.py`
  - `tests/test_pipeline_regression_baseline.py`

### 3.5 运行报告汇总

更新脚本：

- `tools/verify.sh`
- `tools/run_full_pipeline.sh`

新增产物：

- `run_report_steps.csv`
- `run_report_summary.csv`
- `run_report.md`

报告覆盖：步骤耗时、步骤成功率、异常分布（按日志 stage 聚合）、过滤前后数量变化。

## 4. 测试与验收证据

执行通过（节选）：

```bash
python -m unittest -v \
  tests.test_cli_integration \
  tests.test_scoreboard_formal_vs_verify \
  tests.test_pipeline_artifact_validation \
  tests.test_pipeline_regression_baseline
```

以及：

```bash
python -m unittest -v \
  tests.test_verify_scoreboard_recalc \
  tests.test_scoreboard_formal_vs_verify \
  tests.test_pipeline_regression_baseline
```

## 5. 问题与修复记录

### 5.1 `verify_scoreboard_recalc` 测试报错

现象：`test_verify_scoreboard_recalc` 失败，提示核验输入缺少 `基金名称/期初日期/期末日期`。

原因：`verify_scoreboard_recalc_input` stage 错误复用了正式榜单输出契约（`fund_scoreboard_csv`）。

修复：

- 在 `pipeline_contracts.py` 新增 `fund_scoreboard_recalc_input_csv` 契约（仅要求 `基金代码 + VERIFY_FIELDS`）。
- 将 `verify_scoreboard_recalc_input` 映射改为该专用契约。

结果：相关用例回归通过。

## 6. 本次元文件同步

本次已同步更新：

- `docs/README.md`
- `docs/系统设计.md`
- `docs/需求日志/20260227_中间产物契约校验与最小回归基线及运行报告.md`

