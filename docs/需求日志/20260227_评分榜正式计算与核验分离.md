# 需求日志：评分榜正式计算与核验分离

## 1. 需求背景

开发者提出：`verify_scoreboard_recalc.py` 中纯 Python 计算的运行速度远快于 `pipeline_scoreboard.py` 中使用 ClickHouse/MySQL 的流程，而两者的计算目标类似。希望将 Python 版计算逻辑提取为正式计算步骤，ClickHouse/MySQL 流程改为用于核验。

## 2. 关键设计结论

1. **正式计算**：提取 `verify_scoreboard_recalc` 的 Python 计算逻辑，作为主产出路径；产出形态保持 scoreboard 格式（metrics + 基础数据拼接）。
2. **核验**：`run_full_pipeline.sh` 不包含核验；`verify.sh` 包含核验；支持单独核验 CLI（`verify_scoreboard_recalc.py`）。
3. **DB 写入**：正式计算不需要写入 DB；核验所用计算流程需要 DB，核验完成后 DB 数据可清除。
4. **数据**：使用 `verify_20260227_094810_verify_e2e` 的原始数据做回测验证。

## 3. 实现与变更

### 3.1 新增共享模块

- `src/scoreboard_metrics.py`：提取指标计算逻辑（`compute_metrics`、`window_metrics`、`load_nav_df`、`safe_code`、`METRIC_DIRECTIONS`），供 pipeline 与 verify 共用。

### 3.2 改造 pipeline_scoreboard.py

- 新增 `--formal-only`：仅用 Python 计算指标，不构建 nav_df/period_df，不写 DB，显著提速。
- 新增 `_process_one_nav_formal`、`_calc_all_metrics_formal`：轻量级指标计算路径。
- 从 `scoreboard_metrics` 导入 `METRIC_DIRECTIONS`、`compute_metrics`、`window_metrics`、`load_nav_df`，移除重复实现。

### 3.3 改造 verify_scoreboard_recalc.py

- 从 `scoreboard_metrics` 导入计算逻辑，移除重复实现。

### 3.4 脚本适配

- `tools/run_full_pipeline.sh`：Step 7 使用 `--formal-only`，移除 `--resume`、`--apply-ddl`、DB 参数。
- `tools/verify.sh`：保持不变（继续使用完整 pipeline 含 DB 写入，用于核验与回测）。

### 3.5 新增单测

- `tests/test_scoreboard_metrics.py`：共享模块单测。
- `tests/test_cli_integration.py`：新增 `test_pipeline_formal_only_produces_same_metrics_as_full`。
- `tests/test_scoreboard_formal_vs_verify.py`：使用 verify 数据回测，验证 formal 产出经 `verify_scoreboard_recalc` 核验全部通过。

## 4. 验收证据

### 4.1 单测

```bash
cd /Users/zhuaoyuan/cursor-workspace/finance
source myanalyser/.venv312/bin/activate
python -m unittest discover -s myanalyser/tests -p "test_*.py" -v
```

结果：45/45 通过。

### 4.2 回测验证（需 verify 数据）

```bash
python -m unittest myanalyser.tests.test_scoreboard_formal_vs_verify -v
```

在 `data/versions/20260227_094810_verify_e2e` 与 `artifacts/verify_20260227_094810_verify_e2e` 存在时，formal 产出经 `verify_scoreboard_recalc` 核验全部通过。

## 5. 元文件更新

- `docs/README.md`：补充 `scoreboard_metrics`、`--formal-only` 说明，更新正式跑描述。
- `docs/系统设计.md`：补充模块说明，更新验收跑与正式跑描述。
