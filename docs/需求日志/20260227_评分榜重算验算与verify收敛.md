# 需求日志：评分榜重算验算与 verify 收敛

## 1. 需求背景

开发者提出：为 `src/pipeline_scoreboard.py` 的评分结果增加一个独立重算验算脚本，面向小样本（<200）做指标与排名复核，并输出：

- 汇总 CSV（每基金一行：是否全部通过、未通过字段名）
- 明细 CSV（每基金一份：核验项、原结果、新结果、是否通过）

后续追加要求：将 `tools/verify.sh` 的抽样规模从 `100+1` 调整为 `20+1`，并在流程末尾集成重算核验，要求“全部通过才算验收成功”。

## 2. 关键沟通结论

1. 不使用“继续抽样”参数；采用输入行数阈值校验，超过阈值直接报错（避免排名核验失真）。
2. 重算逻辑与 `pipeline_scoreboard.py` 口径对齐：
   - 窗口：`end_date - DateOffset(years=N)`；
   - 频率：周 `W-FRI`、月 `ME`、季 `QE`；
   - 排名：样本内 `rank(method=min)`，方向按 `METRIC_DIRECTIONS`。
3. 核验标准使用导出展示口径（百分比/四舍五入/整数排名）进行比较。
4. 保留调试快照 `metrics_recalc_sample.csv`。

## 3. 实现与变更

### 3.1 新增脚本

- `src/verify_scoreboard_recalc.py`

功能要点：

- 读取评分榜 CSV 与同版本 `fund_etl/fund_adjusted_nav_by_code`；
- 重算 52 个待核验字段（指标与排名）；
- 输出：
  - `summary.csv`
  - `details/{基金代码}.csv`
  - `metrics_recalc_sample.csv`
- 当输入行数超过 `--max-input-rows`（默认 200）时报错退出。

### 3.2 新增测试

- `tests/test_verify_scoreboard_recalc.py`

覆盖点：

- 正常输出汇总/明细/快照；
- 输入超阈值时报错。

### 3.3 验收脚本收敛

- `tools/verify.sh`

调整点：

- Step5 抽样由 `Top100 + 163402` 改为 `Top20 + 163402`（总计 21）；
- 在 Step10 后新增 Step11：
  - 执行 `src/verify_scoreboard_recalc.py`；
  - 检查 `scoreboard_recheck/summary.csv`；
  - 若存在任意基金“待核验字段是否全部核验通过 != 是”，则失败退出；
- 输出新增 `scoreboard_recheck_summary` 路径。

## 4. 验收证据

### 4.1 单测

```bash
cd /Users/zhuaoyuan/cursor-workspace/finance
source myanalyser/.venv312/bin/activate
python -m unittest -v myanalyser/tests/test_verify_scoreboard_recalc.py
```

结果：2/2 通过。

### 4.2 指定版本重算核验

```bash
python myanalyser/src/verify_scoreboard_recalc.py \
  --scoreboard-csv /Users/zhuaoyuan/cursor-workspace/finance/myanalyser/artifacts/verify_20260226_full_e2e_verify_v3/scoreboard/fund_scoreboard_20260226_full_e2e_db_v3.csv \
  --fund-etl-dir /Users/zhuaoyuan/cursor-workspace/finance/myanalyser/data/versions/20260226_full_e2e_verify_v3/fund_etl \
  --output-dir /Users/zhuaoyuan/cursor-workspace/finance/myanalyser/artifacts/verify_20260226_full_e2e_verify_v3/scoreboard_recheck
```

结果：`summary.csv` 全部通过。

### 4.3 统一验收（含 Step11 gating）

```bash
bash myanalyser/tools/verify.sh
```

关键输出样例（run_id=`20260227_094810_verify_e2e`）：

- `step2 total_codes=21`
- `step 11/11: recalc scoreboard verification (must all pass)`
- `recalc verification all passed: funds=13`
- `[verify] OK`

产物：

- `artifacts/verify_20260227_094810_verify_e2e/scoreboard_recheck/summary.csv`

## 5. 过程异常与处理

- 曾出现“文案已改为 21，但磁盘脚本仍执行 101”的不一致问题。
- 已通过读取磁盘文件逐行确认并修复为真实 `top20` 逻辑，再次执行统一验收完成闭环。
