# 需求日志：verify Step10 提速与写入范围收敛

## 1. 背景与问题

在 `tools/verify.sh` 的验收场景中，`step10_scoreboard_and_backtest` 耗时过长。

- 初始观测：`step10` 约 318s
- 第一轮优化后：`step10` 约 178s
- 第二轮优化后：`step10` 约 37s

用户诉求：验收数据量很小，应放开正式跑为防 OOM 引入的限速策略，避免不必要等待。

## 2. 核心诊断

通过分段日志定位，瓶颈不在指标计算与回测：

- `_calc_all_metrics` 约 1s
- `backtest_seconds` 约 3s
- 主要耗时集中在 ClickHouse 写入，尤其是 `fact_fund_nav_daily` / `fact_fund_return_period` 写入链路

## 3. 实现方案

### 3.1 pipeline_scoreboard 新增写入策略参数

新增参数：

- `--clickhouse-write-profile {auto,safe,fast}`
- `--small-data-threshold-funds`（`auto` 判定阈值）
- `--clickhouse-write-scope {full,verify_minimal}`

策略含义：

- `safe`：保守限速（兼容正式跑 OOM 风险控制）
- `fast`：跳过 mutation wait、放宽 chunk/sleep、并行插入
- `auto`：按数据量自动选择 `fast` 或 `safe`
- `verify_minimal`：仅写 `fact_fund_nav_daily` 与 `fact_fund_scoreboard_snapshot`

### 3.2 verify.sh 的 Step10 默认提速配置

`tools/verify.sh` 在 step10 调 `pipeline_scoreboard.py` 时默认传入：

- `--clickhouse-write-profile "${VERIFY_SCOREBOARD_CH_WRITE_PROFILE:-fast}"`
- `--clickhouse-write-scope verify_minimal`

并新增 step10 分段耗时输出：

- `scoreboard_seconds=...`
- `backtest_seconds=...`

## 4. 关键代码变更

- `src/pipeline_scoreboard.py`
  - 增加写入策略解析与配置结构
  - ClickHouse 写入链路改为 profile/scope 驱动
  - `fast` 模式支持并行 chunk 插入
- `tools/verify.sh`
  - Step10 默认使用 `fast + verify_minimal`
  - 打印 step10 分段耗时
- `tests/test_pipeline_scoreboard_clickhouse_write_profile.py`
  - 新增/补充策略单测（含 scope 与 worker 配置断言）

## 5. 验收证据

通过测试：

```bash
bash -n tools/verify.sh
python -m py_compile src/pipeline_scoreboard.py
python -m unittest tests/test_pipeline_scoreboard_clickhouse_write_profile.py
python -m unittest myanalyser.tests.test_cli_integration.CoreCliIntegrationTest.test_pipeline_cli_smoke_skip_sinks_with_run_id_layout
```

运行日志（节选）：

- `[clickhouse] write profile=fast ...`
- `[clickhouse] write scope=verify_minimal, tables=fact_fund_nav_daily,fact_fund_scoreboard_snapshot`
- `[verify] step10 scoreboard_seconds=34`
- `[verify] step10 backtest_seconds=3`

## 6. 结论

本次改动将“正式跑稳定性限速”与“验收跑小数据提速”解耦：

- 正式跑仍可使用 `safe/full` 保守策略
- 验收跑默认使用 `fast/verify_minimal`，显著缩短 Step10 耗时

并通过统一参数化设计，避免再次出现脚本分叉与隐式行为不透明问题。
