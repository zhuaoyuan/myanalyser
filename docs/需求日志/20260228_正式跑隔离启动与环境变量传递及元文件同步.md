# 需求日志：正式跑隔离启动与环境变量传递及元文件同步

- 日期：2026-02-28
- 范围：`tools/start_isolated_pipeline.sh`、`tools/run_full_pipeline.sh`、文档元文件同步

## 1. 背景

`run_full_pipeline.sh` 运行耗时长（数小时），开发过程会继续改代码。需要低成本隔离正式运行代码与开发代码，避免运行中读到不稳定版本。

## 2. 开发者诉求（按轮次）

1. 讨论低成本分离开发与运行环境方案。
2. 提出自动化启动思路：创建 worktree、记录元数据、后台执行并记录日志。
3. 追问 gitignore 但运行所需文件（如 `.venv312`）如何处理。
4. 要求在 `start_isolated_pipeline.sh` 中补充各种用法注释。
5. 追问 `run_full_pipeline.sh` 所需环境变量如何传入。
6. 要求在 `run_full_pipeline.sh` 顶部增加完整命令与注释。
7. 要求将本次变更同步到元文件，且最后一轮明确“不改 `项目通用约束.md`”。

## 3. AI 方案与实现

1. 新增 `tools/start_isolated_pipeline.sh`：
   - 从当前 `HEAD` 创建 detached worktree（默认 `../finance-runs/run_{timestamp}`）。
   - 记录 `VERSION_INFO` / `LAUNCH_INFO`。
   - `nohup` 后台执行 `tools/run_full_pipeline.sh` 并输出 `pipeline.log`。
   - 支持 `--allow-dirty`、`--target-dir`、`@purchase.csv`。
2. 新增 `--venv` 参数：
   - 校验 `<venv>/bin/python`。
   - 注入 `VIRTUAL_ENV` 和 `PATH` 到后台子进程。
3. 在 `tools/run_full_pipeline.sh` 顶部补全“完整运行示例 + 环境变量释义 + 注意事项”注释。
4. 元文件同步（本轮）：
   - 更新 `docs/README.md`：补充隔离启动命令、参数说明、环境变量传递方式、新增运行产物说明。
   - 更新 `docs/系统设计.md`：补充正式跑的隔离启动机制与环境变量透传策略。
   - 未修改 `docs/项目通用约束.md`（按开发者最后要求）。

## 4. 关键命令约定

```bash
# 推荐：隔离正式跑
bash myanalyser/tools/start_isolated_pipeline.sh \
  --venv /Users/zhuaoyuan/cursor-workspace/finance/myanalyser/.venv312

# 通过前缀传 run_full_pipeline 环境变量
ETL_MAX_WORKERS=16 FILTER_START_DATE=2023-01-01 DATA_VERSION=202602_custom \
bash myanalyser/tools/start_isolated_pipeline.sh \
  --venv /Users/zhuaoyuan/cursor-workspace/finance/myanalyser/.venv312
```

## 5. 结果

- 正式长跑可在冻结代码快照中执行，开发目录可并行改动。
- 运行环境和运行参数可追溯（`VERSION_INFO`、`LAUNCH_INFO`、`pipeline.log`）。
- 相关文档已同步到 README 与系统设计，收尾完成。
