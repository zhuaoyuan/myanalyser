# 需求日志：评分榜支持历史截断最新净值日

- 日期：2026-02-28
- 范围：`src/pipeline_scoreboard.py`、`src/verify_scoreboard_recalc.py`、元文件同步

## 1. 背景

为支持“先按历史时点计算 scoreboard，再做选基与回测”的公平回测方案，需要在评分计算与核验中引入统一的“最新净值日截断”口径。

## 2. 开发者诉求（按轮次）

1. 默认行为不变，新增可选项支持指定最新净值日期（如 2025-01-31、2025-12-31）。
2. 优先扩展 `pipeline_scoreboard.py` 与 `verify_scoreboard_recalc.py`。
3. 关于 checkpoint，确认采用“传 `latest_nav_date` 时禁用 `--resume`”，不做更细粒度 checkpoint。
4. 追加问题修复：`最近人事变动日期`需要按历史截断日期计算，不能使用未来公告。
5. 要求按 `项目通用约束.md` 同步项目元文件。

## 3. AI 方案与实现

1. `pipeline_scoreboard.py`
   - 新增参数：`--latest-nav-date`（可选，`YYYY-MM-DD`）。
   - 指标计算前对单基金净值做截断：仅保留 `净值日期 <= latest_nav_date`。
   - 传 `--latest-nav-date` 且有 `--resume` 时，自动禁用 `--resume` 并打印提示。
   - 人事口径修复：`最近人事变动日期`仅在 `公告日期 <= latest_nav_date` 范围内取最大值。
2. `verify_scoreboard_recalc.py`
   - 新增参数：`--latest-nav-date`（可选）。
   - 重算指标前使用同样的净值截断规则。
3. 默认行为保持不变：
   - 不传 `--latest-nav-date` 时，结果与改造前一致。

## 4. 验收与证据

基于数据目录：

- `/Users/zhuaoyuan/cursor-workspace/finance/finance-runs/run_20260228_114010/data/versions/20260228_114010`

执行结果：

1. 默认模式（不传 `--latest-nav-date`）：
   - `pipeline_scoreboard.py` + `verify_scoreboard_recalc.py` 通过；
   - 核验 `summary.csv`：`14/14` 通过；
   - 与原历史产物逐行完全一致（列一致、内容一致）。
2. 历史截断模式（`--latest-nav-date 2025-12-31`）：
   - `pipeline_scoreboard.py` + `verify_scoreboard_recalc.py --latest-nav-date 2025-12-31` 通过；
   - 核验 `summary.csv`：`14/14` 通过；
   - `期末日期`最大值为 `2025-12-31`，无越界记录。
3. 一致性反证：
   - 对历史截断 scoreboard 若不传 `--latest-nav-date` 做 verify，`0/14` 通过（证明核验必须同口径）。
4. 人事日期修复验证：
   - 修复后历史截断产物中 `最近人事变动日期`最大值为 `2025-08-30`，晚于 `2025-12-31` 的记录数为 `0`。

## 5. 元文件同步

本轮已更新：

- `docs/README.md`：新增 `--latest-nav-date` 用法、历史截断口径说明、pipeline/verify 参数一致性说明。
- `docs/系统设计.md`：新增评分榜历史截断设计约束（净值、人事、resume、verify 一致性）。
- `docs/需求日志/20260228_评分榜支持历史截断最新净值日.md`：记录本轮决策与验收证据。

本轮按开发者确认未改动：

- `tools/verify.sh`
- `docs/项目通用约束.md`
