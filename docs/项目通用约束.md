# 项目通用约束

## 1. 适用范围
- （强制）涉及代码、脚本、数据、文档变更的需求，必须执行完整协作工作流。
- （可选）纯问答、纯说明类需求可简化流程（可不进入实现与验收证据阶段）。

## 2. 环境与运行
- （强制）执行项目中的 Python 脚本需要切换到虚拟环境：
  ```bash
  cd /Users/zhuaoyuan/cursor-workspace/finance
  source myanalyser/.venv312/bin/activate
  ```
- （可选）当 git、brew 等命令发生网络异常时，可使用 .zshrc 中已配置好的命令：
  - `proxyon`：一键开启 http/https/socks5 代理
  - `proxyoff`：一键关闭代理

## 3. 协作流程与阶段出口
- （强制）本项目开发者-AI 协作方式遵循固定工作流：  
  需求澄清（开发者） -> 设计与风险（双方对话） -> 实现（AI） -> 验收证据（AI） -> 确认本次需求完成（开发者） -> 更新项目元文件（AI）。
- （强制）【设计与风险】阶段，AI 需充分与开发者讨论设计/选型/功能细节等方面疑议和选项；开始实现前，需先给出“验收清单（可执行命令）”并经开发者确认。
- （强制）【实现】阶段，交付必须包含：
  - 变更文件列表
  - 新增/修改测试点
  - 本地执行命令
  - 关键输出样例

## 4. 统一验收
- （强制）【验收证据】阶段，有代码改动时都需要配套编写和运行测试用例，使每当前任务可以自动化闭环验证。
- （强制）还需要通过一个统一命令（例如 `make verify`）跑完回归测试：单测 + 核心 CLI smoke + 数据完整性检查。
- （强制）当需求涉及数据库链路（MySQL/ClickHouse）时，统一验收必须覆盖端到端流程：数据抓取、预处理、验证、入库、分析与报告产出。

## 5. 异常与降级
- （可选）当外部网络或第三方依赖异常导致流程阻塞时，可临时采用降级验收方案。
- （强制）采用降级方案时，需明确记录：
  - 受影响环节
  - 已执行的替代验证
  - 后续补验计划

## 6. 项目元文件更新
- （强制）【更新项目元文件】阶段，目标是将本次改动过程中涉及的新原则和新逻辑进行概括并写入项目元文件，增强项目可维护性。
- （强制）AI 不直接进行文件变更，而是先列出预计要进行的改动和原因，经与开发者讨论和最终确认后再写入。
- （强制）若本次需求涉及流程、命令、目录结构、核心脚本输入输出变化，则必须更新对应元文件。
- （强制）具体文件包括：
  - `myanalyser/docs/项目通用约束.md`（关于本项目的原则性的工作流、约定、约束条件，在每次会话中都默认读取）
  - `myanalyser/docs/需求日志/{YYYYMMDD}_{需求描述}.md`（记录每次需求中完整会话信息，包含每一轮开发者提示和 AI 回复，留档记录）
  - `myanalyser/docs/README.md`（基本功能和命令介绍，保持与项目文件、代码、实际情况同步更新）
  - `myanalyser/docs/系统设计.md`（项目整体架构、关键模块、业务流程设计，保持与项目文件、代码、实际情况同步更新）
  - `myanalyser/tools/verify.sh`（闭环验证脚本，包含虚拟环境检查、单测、核心 CLI smoke、数据库联调与端到端产物检查（使用测试 run_id））
